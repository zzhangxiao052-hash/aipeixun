<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶è—åŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2563eb;
      margin-top: 0;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button.danger {
      background: #dc2626;
    }
    button.danger:hover {
      background: #b91c1c;
    }
    .output {
      background: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .bookmark-item {
      background: #f3f4f6;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .success {
      color: #059669;
      font-weight: bold;
    }
    .error {
      color: #dc2626;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ”– æ”¶è—åŠŸèƒ½æµ‹è¯•å·¥å…·</h1>
  
  <div class="test-section">
    <h2>1. æŸ¥çœ‹å½“å‰æ”¶è—</h2>
    <button onclick="viewBookmarks()">åˆ·æ–°æ”¶è—åˆ—è¡¨</button>
    <button onclick="clearAll()" class="danger">æ¸…ç©ºæ‰€æœ‰æ”¶è—</button>
    <div id="bookmarks-output" class="output">ç‚¹å‡»"åˆ·æ–°æ”¶è—åˆ—è¡¨"æŸ¥çœ‹æ•°æ®</div>
  </div>

  <div class="test-section">
    <h2>2. æ·»åŠ æµ‹è¯•æ”¶è—</h2>
    <button onclick="addTestBookmark()">æ·»åŠ æµ‹è¯•è§†é¢‘æ”¶è—</button>
    <div id="add-output" class="output"></div>
  </div>

  <div class="test-section">
    <h2>3. åˆ é™¤æ”¶è—æµ‹è¯•</h2>
    <button onclick="deleteByVideoId()">é€šè¿‡ videoId åˆ é™¤(è§†é¢‘201)</button>
    <button onclick="deleteById()">é€šè¿‡ id åˆ é™¤ç¬¬ä¸€ä¸ª</button>
    <div id="delete-output" class="output"></div>
  </div>

  <div class="test-section">
    <h2>4. æ•°æ®æ¸…æ´—æµ‹è¯•</h2>
    <button onclick="addDirtyData()">æ·»åŠ è„æ•°æ®(æ— videoId)</button>
    <button onclick="testCleanup()">æµ‹è¯•è‡ªåŠ¨æ¸…æ´—</button>
    <div id="cleanup-output" class="output"></div>
  </div>

  <script>
    // æ¨¡æ‹Ÿ useBookmarks Hook çš„æ¸…æ´—é€»è¾‘
    function cleanupBookmarks(bookmarks) {
      return bookmarks
        .filter(item => item.videoId || item.title)
        .map(item => {
          if (!item.videoId && item.title) {
            const hashId = `legacy_${item.title.split('').reduce((acc, char) => {
              return ((acc << 5) - acc) + char.charCodeAt(0);
            }, 0)}`;
            item.videoId = hashId;
          }
          
          if (item.videoId !== undefined && item.videoId !== null) {
            item.videoId = String(item.videoId);
          }
          
          if (!item.id) {
            item.id = item.videoId || Date.now();
          }
          
          item.id = String(item.id);
          
          return item;
        });
    }

    function loadBookmarks() {
      try {
        const raw = localStorage.getItem('user_assets');
        const bookmarks = raw ? JSON.parse(raw) : [];
        const cleaned = cleanupBookmarks(bookmarks);
        
        if (JSON.stringify(bookmarks) !== JSON.stringify(cleaned)) {
          localStorage.setItem('user_assets', JSON.stringify(cleaned));
          console.log('âœ… æ•°æ®å·²è‡ªåŠ¨æ¸…æ´—');
        }
        
        return cleaned;
      } catch (error) {
        console.error('Failed to load bookmarks:', error);
        return [];
      }
    }

    function saveBookmarks(bookmarks) {
      try {
        const cleaned = cleanupBookmarks(bookmarks);
        localStorage.setItem('user_assets', JSON.stringify(cleaned));
        window.dispatchEvent(new Event('storage'));
        return cleaned;
      } catch (error) {
        console.error('Failed to save bookmarks:', error);
        return bookmarks;
      }
    }

    function viewBookmarks() {
      const bookmarks = loadBookmarks();
      const output = document.getElementById('bookmarks-output');
      
      if (bookmarks.length === 0) {
        output.innerHTML = '<p class="error">æš‚æ— æ”¶è—</p>';
        return;
      }
      
      let html = `<p class="success">å…± ${bookmarks.length} ä¸ªæ”¶è—:</p>`;
      bookmarks.forEach((b, index) => {
        html += `
          <div class="bookmark-item">
            <div>
              <strong>${index + 1}. ${b.title || 'æ— æ ‡é¢˜'}</strong><br>
              <small>id: ${b.id} | videoId: ${b.videoId} | folder: ${b.folder || 'é»˜è®¤'}</small>
            </div>
          </div>
        `;
      });
      
      output.innerHTML = html;
    }

    function addTestBookmark() {
      const bookmarks = loadBookmarks();
      const newBookmark = {
        id: Date.now(),
        videoId: '201',
        title: 'DeepSeek æ·±åº¦è§£æ:å›½äº§å¤§æ¨¡å‹åº”ç”¨å®æˆ˜',
        content: 'æœ¬è¯¾ç¨‹æ·±å…¥è§£æ DeepSeek å¤§æ¨¡å‹çš„æ¶æ„ä¸åº”ç”¨åœºæ™¯',
        tags: ['å¤§æ¨¡å‹', 'å†™ä½œ', 'æ•ˆç‡'],
        date: new Date().toISOString().split('T')[0],
        folder: 'æˆ‘çš„æŠ€å·§åº“ (é»˜è®¤)',
        type: 'video_bookmark'
      };
      
      const updated = [newBookmark, ...bookmarks];
      saveBookmarks(updated);
      
      const output = document.getElementById('add-output');
      output.innerHTML = `<p class="success">âœ… æ·»åŠ æˆåŠŸ! ID: ${newBookmark.id}</p>`;
      
      viewBookmarks();
    }

    function deleteByVideoId() {
      const bookmarks = loadBookmarks();
      const targetVideoId = '201';
      const updated = bookmarks.filter(b => String(b.videoId) !== targetVideoId);
      
      saveBookmarks(updated);
      
      const output = document.getElementById('delete-output');
      const deleted = bookmarks.length - updated.length;
      output.innerHTML = `<p class="success">âœ… é€šè¿‡ videoId åˆ é™¤äº† ${deleted} ä¸ªæ”¶è—</p>`;
      
      viewBookmarks();
    }

    function deleteById() {
      const bookmarks = loadBookmarks();
      if (bookmarks.length === 0) {
        const output = document.getElementById('delete-output');
        output.innerHTML = '<p class="error">âŒ æ²¡æœ‰å¯åˆ é™¤çš„æ”¶è—</p>';
        return;
      }
      
      const firstId = bookmarks[0].id;
      const updated = bookmarks.filter(b => String(b.id) !== String(firstId));
      
      saveBookmarks(updated);
      
      const output = document.getElementById('delete-output');
      output.innerHTML = `<p class="success">âœ… åˆ é™¤äº† ID ä¸º ${firstId} çš„æ”¶è—</p>`;
      
      viewBookmarks();
    }

    function addDirtyData() {
      const bookmarks = loadBookmarks();
      const dirtyData = {
        id: Date.now(),
        // æ•…æ„ä¸æ·»åŠ  videoId
        title: 'æ—§ç‰ˆæœ¬æ”¶è—æ•°æ®(æ— videoId)',
        content: 'è¿™æ˜¯ä¸€æ¡æ—§ç‰ˆæœ¬çš„æ•°æ®',
        tags: ['æµ‹è¯•'],
        date: '2023-01-01'
      };
      
      const updated = [dirtyData, ...bookmarks];
      localStorage.setItem('user_assets', JSON.stringify(updated));
      
      const output = document.getElementById('cleanup-output');
      output.innerHTML = '<p class="success">âœ… å·²æ·»åŠ è„æ•°æ®(æ— videoId)</p>';
      
      viewBookmarks();
    }

    function testCleanup() {
      const output = document.getElementById('cleanup-output');
      output.innerHTML = '<p>æ­£åœ¨æ¸…æ´—æ•°æ®...</p>';
      
      setTimeout(() => {
        const cleaned = loadBookmarks();
        const hasVideoId = cleaned.every(b => b.videoId);
        
        if (hasVideoId) {
          output.innerHTML = '<p class="success">âœ… æ¸…æ´—æˆåŠŸ!æ‰€æœ‰æ•°æ®éƒ½æœ‰ videoId</p>';
        } else {
          output.innerHTML = '<p class="error">âŒ æ¸…æ´—å¤±è´¥,ä»æœ‰æ•°æ®ç¼ºå°‘ videoId</p>';
        }
        
        viewBookmarks();
      }, 100);
    }

    function clearAll() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å—?')) {
        localStorage.setItem('user_assets', '[]');
        window.dispatchEvent(new Event('storage'));
        viewBookmarks();
      }
    }

    // ç›‘å¬ storage äº‹ä»¶
    window.addEventListener('storage', () => {
      console.log('ğŸ”” æ”¶åˆ° storage äº‹ä»¶,è‡ªåŠ¨åˆ·æ–°...');
      viewBookmarks();
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤º
    viewBookmarks();
  </script>
</body>
</html>
